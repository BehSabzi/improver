#!/usr/bin/env python
# -*- coding: utf-8 -*-
# -----------------------------------------------------------------------------
# (C) British Crown Copyright 2017 Met Office.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# * Redistributions of source code must retain the above copyright notice, this
#   list of conditions and the following disclaimer.
#
# * Redistributions in binary form must reproduce the above copyright notice,
#   this list of conditions and the following disclaimer in the documentation
#   and/or other materials provided with the distribution.
#
# * Neither the name of the copyright holder nor the names of its
#   contributors may be used to endorse or promote products derived from
#   this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
# LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
# CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
"""Script to run Ensemble Copula Coupling processing."""



import iris
from iris.exceptions import CoordinateNotFoundError

import numpy as np

from improver.ensemble_copula_coupling.ensemble_copula_coupling import (
    RebadgePercentilesAsMembers, ResamplePercentiles, EnsembleReordering)
from improver.argparser import ArgParser

def main():
    """
    Load in the arguments and apply the requested variant of Ensemble
    Copula Coupling.
    """
    parser = ArgParser(
        description='Apply Ensemble Copula Coupling '
                    'to a file with one cube.')

    # General options:
    parser.add_argument('input_filepath', metavar='INPUT_FILE',
                        help='A path to an input NetCDF file to be processed')
    parser.add_argument('output_filepath', metavar='OUTPUT_FILE',
                        help='The output path for the processed NetCDF')
    parser.add_argument('--no_of_percentiles', default=None, type=int,
                        metavar='NUMBER_OF_PERCENTILES',
                        help='The number of percentiles to be generated.')
    parser.add_argument('--sampling_method', default='quantile',
                        const='quantile', nargs='?',
                        choices=['quantile', 'random'],
                        metavar='PERCENTILE_SAMPLING_METHOD',
                        help='Method to be used for generating the list of '
                             'percentiles with forecasts generated at each '
                             'percentile. "quantile" is the default option.')

    # Different use cases:
    # (We can either reorder OR rebadge)
    group = parser.add_mutually_exclusive_group(required=True)

    group.add_argument('--reordering', default=False, action='store_true',
        help='The option used to create ensemble members '
             'from percentiles by reordering the input '
             'percentiles based on the order of the '
             'raw ensemble forecast.')
    group.add_argument('--rebadging', default=False, action='store_true',
        help='The option used to create ensemble members '
              'from percentiles by rebadging the input '
              'percentiles.')

    # If reordering, can do so either based on original members, or randomly.
    reordering = parser.add_argument_group(
        'Reordering options', 'Options for reordering the input percentiles '
        'using the raw ensemble forecast as required to create ensemble '
        'members.')
    reordering.add_argument('--raw_forecast_filepath',
                        metavar='RAW_FORECAST_FILE',
                        help='A path to an raw forecast NetCDF file to be '
                             'processed.')
    reordering.add_argument('--random_ordering',
                        help='Decide whether or not to use random ordering '
                             'within the ensemble reordering step.')

    rebadging = parser.add_argument_group(
        'Rebadging options', 'Options for rebadging the input percentiles '
        'as ensemble members.')
    rebadging.add_argument('--member_numbers', default=None,
        metavar='MEMBER_NUMBERS',
        help='A list of ensemble member numbers to use '
              'when rebadging the percentiles into members.')

    args = parser.parse_args()

    # CLI argument checking:
    # Can only do one of reordering or rebadging: if options are passed which
    # correspond to the opposite method, raise an exception.
    # Note: Shouldn't need to check that both/none are set, since they are
    # defined as mandatory, but mutually exclusive, options.
    if args.reordering:
        if np.any([args.member_numbers]):
            parser.wrong_args_error('member_numbers', 'reordering')
    elif args.rebadging:
        if np.any([args.raw_forecast_filepath, args.random_ordering]):
            parser.wrong_args_error(
                'raw_forecast_filepath, random_ordering', 'rebadging')


    # Safe to now actually do the work...
    cube = iris.load_cube(args.input_filepath)

    # TODO: checking should eventually be moved into the framework itself:
    if not cube.coords('percentile_over_realization'):
        msg = ('The input cube: {} does not have a '
               'percentile_over_realization dimension.'.format(cube))
        raise CoordinateNotFoundError(msg)

    # For now, assume only doing percentiles -> percentiles
    result_cube = ResamplePercentiles().process(
        cube, no_of_percentiles=args.no_of_percentiles,
        sampling=args.sampling_method)

    if args.reordering:
        raw_forecast = iris.load_cube(args.raw_forecast_filepath)
        result_cube = EnsembleReordering().process(
            cube, raw_forecast, random_ordering=args.random_ordering)
    elif args.rebadging:
        result_cube = RebadgePercentilesAsMembers().process(
            cube, ensemble_member_numbers=args.member_numbers)

    iris.save(result_cube, args.output_filepath)


if __name__ == '__main__':
    main()
